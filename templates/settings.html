<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - RHEL9 VM Provisioning</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Theme toggle specific styles */
        .theme-switcher {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 15px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input-bg);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-color);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .theme-icon {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Application Settings</h1>
            <nav>
                <ul>
                    <li><a href="{{ url_for('index') }}">Create VM</a></li>
                    <li><a href="{{ url_for('list_configs') }}">View Configurations</a></li>
                    {% if user_role == 'admin' %}
                    <li><a href="{{ url_for('admin_users') }}">Manage Users</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('settings') }}" class="active">Settings</a></li>
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card">
                <h2>User Preferences</h2>
                
                <div class="form-section">
                    <h3>Theme Settings</h3>
                    <div class="theme-switcher">
                        <span class="theme-icon">üåô</span>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                        <span class="theme-icon">‚òÄÔ∏è</span>
                    </div>
                    <p>Choose between dark and light theme for the application.</p>
                </div>
            </div>

            {% if user_role == 'admin' %}
            <div class="card">
                <h2>Application Environment Settings</h2>
                <p class="info-panel">
                    <span class="info-title">About Environment Settings</span>
                    <div class="info-content">
                        These settings affect the application's behavior and are stored in the .env file.
                        Changes made here will be applied to the application after saving.
                    </div>
                </p>
                
                <form action="{{ url_for('update_env_settings') }}" method="post">
                    <div class="form-section">
                        <h3>Server Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config_dir">Configuration Directory:</label>
                                <input type="text" id="config_dir" name="config_dir" value="{{ env_settings.get('CONFIG_DIR', 'configs') }}">
                                <small>Directory to store VM configuration files</small>
                            </div>
                            <div class="form-group">
                                <label for="terraform_dir">Terraform Directory:</label>
                                <input type="text" id="terraform_dir" name="terraform_dir" value="{{ env_settings.get('TERRAFORM_DIR', 'terraform') }}">
                                <small>Directory to store Terraform files</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Terraform & Atlantis Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="atlantis_url">Atlantis URL:</label>
                                <input type="text" id="atlantis_url" name="atlantis_url" value="{{ env_settings.get('ATLANTIS_URL', 'http://atlantis:4141') }}">
                                <small>URL of the Atlantis server</small>
                            </div>
                            <div class="form-group">
                                <label for="atlantis_token">Atlantis Token:</label>
                                <input type="password" id="atlantis_token" name="atlantis_token" value="{{ env_settings.get('ATLANTIS_TOKEN', '') }}">
                                <small>API token for Atlantis authentication</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Application Security</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="flask_secret_key">Flask Secret Key:</label>
                                <input type="password" id="flask_secret_key" name="flask_secret_key" value="{{ env_settings.get('FLASK_SECRET_KEY', '') }}">
                                <small>Secret key for Flask session encryption (generated automatically if empty)</small>
                            </div>
                            <div class="form-group">
                                <label for="users_file">Users File Path:</label>
                                <input type="text" id="users_file" name="users_file" value="{{ env_settings.get('USERS_FILE', 'users.json') }}">
                                <small>Path to the users configuration file</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>vSphere Connection Settings</h3>
                        <div class="connection-status-panel">
                            <div class="status-indicator" id="vsphere-status-indicator">
                                <span class="status-badge unknown">Unknown</span>
                            </div>
                            <button type="button" id="test-vsphere-connection" class="btn btn-small">Test Connection</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vsphere_server">vSphere Server:</label>
                                <input type="text" id="vsphere_server" name="vsphere_server" value="{{ env_settings.get('VSPHERE_SERVER', '') }}">
                                <small>vCenter Server address (FQDN or IP)</small>
                            </div>
                            <div class="form-group">
                                <label for="vsphere_port">vSphere Port:</label>
                                <input type="text" id="vsphere_port" name="vsphere_port" value="{{ env_settings.get('VSPHERE_PORT', '443') }}">
                                <small>Port for vCenter Server (default: 443)</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vsphere_user">vSphere Username:</label>
                                <input type="text" id="vsphere_user" name="vsphere_user" value="{{ env_settings.get('VSPHERE_USER', '') }}">
                                <small>Username for vSphere authentication (domain\username format)</small>
                            </div>
                            <div class="form-group">
                                <label for="vsphere_password">vSphere Password:</label>
                                <input type="password" id="vsphere_password" name="vsphere_password" value="{{ env_settings.get('VSPHERE_PASSWORD', '') }}">
                                <small>Password for vSphere authentication</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vsphere_use_ssl">Use SSL:</label>
                                <select id="vsphere_use_ssl" name="vsphere_use_ssl">
                                    <option value="true" {% if env_settings.get('VSPHERE_USE_SSL', 'true').lower() == 'true' %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if env_settings.get('VSPHERE_USE_SSL', 'true').lower() == 'false' %}selected{% endif %}>No</option>
                                </select>
                                <small>Use SSL for vSphere connection</small>
                            </div>
                            <div class="form-group">
                                <label for="vsphere_verify_ssl">Verify SSL:</label>
                                <select id="vsphere_verify_ssl" name="vsphere_verify_ssl">
                                    <option value="true" {% if env_settings.get('VSPHERE_VERIFY_SSL', 'false').lower() == 'true' %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if env_settings.get('VSPHERE_VERIFY_SSL', 'false').lower() == 'false' %}selected{% endif %}>No</option>
                                </select>
                                <small>Verify SSL certificates (disable for self-signed certs)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>NetBox Connection Settings</h3>
                        <div class="connection-status-panel">
                            <div class="status-indicator" id="netbox-status-indicator">
                                <span class="status-badge unknown">Unknown</span>
                            </div>
                            <button type="button" id="test-netbox-connection" class="btn btn-small">Test Connection</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="netbox_url">NetBox URL:</label>
                                <input type="text" id="netbox_url" name="netbox_url" value="{{ env_settings.get('NETBOX_URL', '') }}">
                                <small>NetBox API URL (e.g., https://netbox.example.com/api)</small>
                            </div>
                            <div class="form-group">
                                <label for="netbox_token">NetBox API Token:</label>
                                <input type="password" id="netbox_token" name="netbox_token" value="{{ env_settings.get('NETBOX_TOKEN', '') }}">
                                <small>API token for NetBox authentication</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="netbox_verify_ssl">Verify SSL:</label>
                                <select id="netbox_verify_ssl" name="netbox_verify_ssl">
                                    <option value="true" {% if env_settings.get('NETBOX_VERIFY_SSL', 'true').lower() == 'true' %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if env_settings.get('NETBOX_VERIFY_SSL', 'true').lower() == 'false' %}selected{% endif %}>No</option>
                                </select>
                                <small>Verify SSL certificates for NetBox API (disable for self-signed certs)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Redis Configuration</h3>
                        <div class="connection-status-panel">
                            <div class="status-indicator" id="redis-status-indicator">
                                <span class="status-badge unknown">Unknown</span>
                            </div>
                            <button type="button" id="test-redis-connection" class="btn btn-small">Test Connection</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="redis_host">Redis Host:</label>
                                <input type="text" id="redis_host" name="redis_host" value="{{ env_settings.get('REDIS_HOST', 'localhost') }}">
                                <small>Redis server hostname or IP address</small>
                            </div>
                            <div class="form-group">
                                <label for="redis_port">Redis Port:</label>
                                <input type="text" id="redis_port" name="redis_port" value="{{ env_settings.get('REDIS_PORT', '6379') }}">
                                <small>Redis server port (default: 6379)</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="redis_password">Redis Password:</label>
                                <input type="password" id="redis_password" name="redis_password" value="{{ env_settings.get('REDIS_PASSWORD', '') }}">
                                <small>Redis password (leave empty if not required)</small>
                            </div>
                            <div class="form-group">
                                <label for="redis_cache_ttl">Cache TTL (seconds):</label>
                                <input type="number" id="redis_cache_ttl" name="redis_cache_ttl" value="{{ env_settings.get('REDIS_CACHE_TTL', '3600') }}">
                                <small>Time to live for cached data (default: 3600s)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Environment Settings</button>
                        <button type="reset" class="btn">Reset</button>
                        <button type="button" id="restart-application" class="btn btn-warning">Save & Restart Application</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <h2>Redis Cache Management</h2>
                <div class="form-section">
                    <h3>Cache Status</h3>
                    <p id="cache-status-display">Checking cache status...</p>
                    
                    <div id="cache-performance-metrics" class="performance-metrics">
                        <div class="metrics-row">
                            <div class="metric-card">
                                <span class="metric-title">Cache Hit Rate</span>
                                <span class="metric-value" id="cache-hit-rate">-</span>
                            </div>
                            <div class="metric-card">
                                <span class="metric-title">Memory Usage</span>
                                <span class="metric-value" id="memory-usage">-</span>
                            </div>
                            <div class="metric-card">
                                <span class="metric-title">Sync Duration</span>
                                <span class="metric-value" id="sync-duration">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cache-management">
                        <h4>Cache Management</h4>
                        <div class="cache-info">
                            <p>The vSphere cache stores infrastructure data to improve application performance. This prevents excessive API calls to the vSphere server when users are viewing or creating VMs.</p>
                            <p>Cache synchronization status: <span id="sync-status">Unknown</span></p>
                        </div>
                        
                        <!-- Added sync progress bar -->
                        <div class="sync-progress-container" id="sync-progress-container" style="display: none;">
                            <p id="sync-progress-message">Syncing data...</p>
                            <div class="progress-container">
                                <div class="progress-bar" id="sync-progress-bar"></div>
                            </div>
                        </div>
                        
                        <div class="cache-actions">
                            <button id="sync-essential-cache" class="btn">Sync Essential Data</button>
                            <button id="sync-full-cache" class="btn btn-primary">Sync All Data</button>
                            <button id="clear-resource-cache" class="btn btn-danger">Clear Cache</button>
                            <button id="refresh-cache-status" class="btn">Refresh Status</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </main>

        <footer>
            <p>&copy; 2025 CH Robinson - RHEL9 VM Provisioning Tool</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    {% if user_role == 'admin' %}
    <script>
        // Redis cache management scripts
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch cache status on page load
            fetchCacheStatus();
            
            // Set up refresh button
            document.getElementById('refresh-cache-status').addEventListener('click', fetchCacheStatus);
            
            // Set up sync button
            document.getElementById('sync-essential-cache').addEventListener('click', function() {
                syncResourceCache('essential');
            });
            
            document.getElementById('sync-full-cache').addEventListener('click', function() {
                syncResourceCache('full');
            });
            
            // Set up clear button
            document.getElementById('clear-resource-cache').addEventListener('click', clearResourceCache);
            
            // Auto-test connections after a short delay
            setTimeout(function() {
                // Test all connections with current settings
                testVsphereConnection();
                testNetboxConnection();
                testRedisConnection();
            }, 1500); // Small delay to let page load completely
        });
        
        function fetchCacheStatus() {
            const statusElement = document.getElementById('cache-status-display');
            statusElement.textContent = 'Checking cache status...';
            
            fetch('/api/vsphere-cache/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusElement.innerHTML = `
                            <strong>Last Updated:</strong> ${data.status.last_updated || 'Never'}<br>
                            <strong>Total Objects:</strong> ${data.status.total_objects || 0}<br>
                            <strong>Cache Health:</strong> ${data.status.connected ? '<span class="status-badge completed">Connected</span>' : '<span class="status-badge failed">Disconnected</span>'}
                        `;
                        document.getElementById('cache-hit-rate').textContent = data.status.cache_hit_rate || '-';
                        document.getElementById('memory-usage').textContent = data.status.memory_usage || '-';
                        document.getElementById('sync-duration').textContent = data.status.sync_duration || '-';
                    } else {
                        statusElement.innerHTML = `<span class="status-badge failed">Error: ${data.error}</span>`;
                    }
                })
                .catch(error => {
                    statusElement.innerHTML = `<span class="status-badge failed">Connection Error: ${error.message}</span>`;
                });
        }
        
        function syncResourceCache(strategy) {
            const statusElement = document.getElementById('cache-status-display');
            statusElement.innerHTML = '<span class="status-badge planning">Syncing resource data...</span>';
            
            // Show progress bar
            const progressContainer = document.getElementById('sync-progress-container');
            const progressBar = document.getElementById('sync-progress-bar');
            const progressMessage = document.getElementById('sync-progress-message');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressMessage.textContent = 'Syncing data...';
            
            fetch('/api/vsphere-cache/sync', {
                method: 'POST',
                body: JSON.stringify({
                    strategy: strategy
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusElement.innerHTML = `<span class="status-badge completed">${data.message}</span>`;
                        progressBar.style.width = '100%';
                        progressMessage.textContent = 'Sync completed';
                        // Refresh the status after a short delay
                        setTimeout(fetchCacheStatus, 2000);
                    } else {
                        statusElement.innerHTML = `<span class="status-badge failed">Error: ${data.error}</span>`;
                        progressMessage.textContent = 'Sync failed';
                    }
                })
                .catch(error => {
                    statusElement.innerHTML = `<span class="status-badge failed">Connection Error: ${error.message}</span>`;
                    progressMessage.textContent = 'Sync failed';
                })
                .finally(() => {
                    // Hide progress bar after a short delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                });
        }
        
        function clearResourceCache() {
            if (!confirm('Are you sure you want to clear the resource cache? This will remove all cached data.')) {
                return;
            }
            
            const statusElement = document.getElementById('cache-status-display');
            statusElement.innerHTML = '<span class="status-badge planning">Clearing resource cache...</span>';
            
            fetch('/api/vsphere-cache/clear', {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusElement.innerHTML = `<span class="status-badge completed">${data.message}</span>`;
                        // Refresh the status after a short delay
                        setTimeout(fetchCacheStatus, 2000);
                    } else {
                        statusElement.innerHTML = `<span class="status-badge failed">Error: ${data.error}</span>`;
                    }
                })
                .catch(error => {
                    statusElement.innerHTML = `<span class="status-badge failed">Connection Error: ${error.message}</span>`;
                });
        }
        
        // Connection testing scripts
        document.addEventListener('DOMContentLoaded', function() {
            // Set up connection test buttons
            document.getElementById('test-vsphere-connection').addEventListener('click', function() {
                testVsphereConnection();
            });
            
            document.getElementById('test-netbox-connection').addEventListener('click', function() {
                testNetboxConnection();
            });
            
            document.getElementById('test-redis-connection').addEventListener('click', function() {
                testRedisConnection();
            });
        });
        
        function testVsphereConnection() {
            updateConnectionStatus('vsphere', 'working', 'Testing connection...');
            
            // Get current form values
            const server = document.getElementById('vsphere_server').value;
            const port = document.getElementById('vsphere_port').value;
            const username = document.getElementById('vsphere_user').value;
            const password = document.getElementById('vsphere_password').value;
            const useSSL = document.getElementById('vsphere_use_ssl').value;
            const verifySSL = document.getElementById('vsphere_verify_ssl').value;
            
            // Validate required fields
            if (!server || !username || !password) {
                updateConnectionStatus('vsphere', 'error', 'Missing required fields (server, username, password)');
                return;
            }
            
            fetch('/api/test-connection/vsphere', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    server: server,
                    port: port,
                    username: username,
                    password: password,
                    use_ssl: useSSL,
                    verify_ssl: verifySSL
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateConnectionStatus('vsphere', 'success', `Connected successfully: ${data.message}`);
                } else {
                    updateConnectionStatus('vsphere', 'error', `Connection failed: ${data.error}`);
                }
            })
            .catch(error => {
                updateConnectionStatus('vsphere', 'error', `Error: ${error.message}`);
            });
        }
        
        function testNetboxConnection() {
            updateConnectionStatus('netbox', 'working', 'Testing connection...');
            
            // Get current form values
            const url = document.getElementById('netbox_url').value;
            const token = document.getElementById('netbox_token').value;
            const verifySSL = document.getElementById('netbox_verify_ssl').value;
            
            // Validate required fields
            if (!url || !token) {
                updateConnectionStatus('netbox', 'error', 'Missing required fields (URL, API token)');
                return;
            }
            
            fetch('/api/test-connection/netbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    token: token,
                    verify_ssl: verifySSL
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateConnectionStatus('netbox', 'success', `Connected successfully: ${data.message}`);
                } else {
                    updateConnectionStatus('netbox', 'error', `Connection failed: ${data.error}`);
                }
            })
            .catch(error => {
                updateConnectionStatus('netbox', 'error', `Error: ${error.message}`);
            });
        }
        
        function testRedisConnection() {
            updateConnectionStatus('redis', 'working', 'Testing connection...');
            
            // Get current form values
            const host = document.getElementById('redis_host').value;
            const port = document.getElementById('redis_port').value;
            const password = document.getElementById('redis_password').value;
            
            // Validate required fields
            if (!host || !port) {
                updateConnectionStatus('redis', 'error', 'Missing required fields (host, port)');
                return;
            }
            
            fetch('/api/test-connection/redis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    host: host,
                    port: port,
                    password: password || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateConnectionStatus('redis', 'success', `Connected successfully: ${data.message}`);
                } else {
                    updateConnectionStatus('redis', 'error', `Connection failed: ${data.error}`);
                }
            })
            .catch(error => {
                updateConnectionStatus('redis', 'error', `Error: ${error.message}`);
            });
        }
        
        function updateConnectionStatus(service, status, message) {
            const indicator = document.getElementById(`${service}-status-indicator`);
            const statusBadge = indicator.querySelector('.status-badge');
            
            // Remove all existing status classes
            statusBadge.classList.remove('unknown', 'working', 'success', 'error');
            
            // Add new status class
            statusBadge.classList.add(status);
            
            // Update text
            statusBadge.textContent = message || status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        // Add event listener for the restart application button
        document.getElementById('restart-application').addEventListener('click', function() {
            if (confirm('Are you sure you want to save settings and restart the application? This may briefly interrupt service.')) {
                // First save form data via standard form submission
                document.querySelector('form').submit();
                
                // Then restart the application
                setTimeout(function() {
                    restartApplication();
                }, 1500); // Allow time for form submission to complete
            }
        });
        
        function restartApplication() {
            fetch('/restart-application', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    save_changes: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert(`${data.message} The page will now refresh.`);
                    
                    // Refresh the page after a short delay
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    alert(`Error restarting application: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        }
    </script>
    {% endif %}
</body>
</html>