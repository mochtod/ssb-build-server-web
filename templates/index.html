<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL9 VM Provisioning</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-mode">
    <div class="container">
        <header>
            <h1>RHEL9 VM Provisioning</h1>
            <nav>
                <ul>
                    <li><a href="{{ url_for('index') }}" class="active">Create VM</a></li>
                    <li><a href="{{ url_for('list_configs') }}">View Configurations</a></li>
                    {% if user_role == 'admin' %}
                    <li><a href="{{ url_for('admin_users') }}">Manage Users</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card">
                <h2>Create New Virtual Machine</h2>
                <form action="{{ url_for('submit') }}" method="post">
                    <div class="form-section">
                        <h3>VM Identification</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="server_prefix">Server Environment:</label>
                                <select id="server_prefix" name="server_prefix" required>
                                    <option value="">Select environment</option>
                                    <optgroup label="Non-Production">
                                        {% for prefix in environments.nonprod %}
                                            <option value="{{ prefix }}">{{ prefix }} ({{ server_prefixes[prefix] }})</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="Production">
                                        {% for prefix in environments.prod %}
                                            <option value="{{ prefix }}">{{ prefix }} ({{ server_prefixes[prefix] }})</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="app_name">Application Name (3-5 chars):</label>
                                <input type="text" id="app_name" name="app_name" maxlength="5" minlength="3" required>
                                <small>Example: web, app, db, ssbs</small>
                            </div>
                        </div>
                        <p class="preview">Preview: <span id="name_preview">lin2xx-app-10001</span></p>
                    </div>

                    <!-- vSphere Configuration Section -->
                    <div class="form-section" id="vsphere-section">
                        <h3>vSphere Configuration</h3>
                        
                        <!-- Only show loading indicator if no cached data is available -->
                        {% if not vsphere_data %}
                        <div id="vsphere-loading" class="loading-indicator">
                            <div class="spinner"></div>
                            <p>Loading vSphere data... <span id="loading-detail">Initializing</span></p>
                            <div class="progress-container">
                                <div class="progress-bar" id="loading-progress-bar"></div>
                            </div>
                        </div>
                        
                        <div id="vsphere-error-message" class="alert alert-error" style="display: none;">
                            Error loading vSphere data. <button id="retry-vsphere-load" class="btn-small">Retry</button>
                            <button id="use-cached-data" class="btn-small">Use Cached Data</button>
                        </div>
                        {% endif %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vsphere_server">vSphere Server:</label>
                                <select id="vsphere_server" name="vsphere_server" required>
                                    <option value="">Select vSphere Server</option>
                                    {% if vsphere_data and vsphere_data.vsphere_servers %}
                                        {% for server in vsphere_data.vsphere_servers %}
                                            <option value="{{ server.id }}">{{ server.name }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="virtualcenter.chrobinson.com">virtualcenter.chrobinson.com PROD</option>
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="server-loading-status">Connecting...</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="datacenter">Datacenter:</label>
                                <select id="datacenter" name="datacenter" required>
                                    <option value="">Select Datacenter</option>
                                    {% if vsphere_data and vsphere_data.datacenters %}
                                        {% for datacenter in vsphere_data.datacenters %}
                                            <option value="{{ datacenter.id }}">{{ datacenter.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="datacenter-loading-status">Waiting for server selection...</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cluster">Cluster:</label>
                                <select id="cluster" name="cluster" required>
                                    <option value="">Select Cluster</option>
                                    {% if vsphere_data and vsphere_data.clusters %}
                                        {% for cluster in vsphere_data.clusters %}
                                            <option value="{{ cluster.id }}">{{ cluster.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="cluster-loading-status">Waiting for datacenter selection...</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="datastore_cluster">Datastore Cluster:</label>
                                <select id="datastore_cluster" name="datastore_cluster" required>
                                    <option value="">Select Datastore Cluster</option>
                                    {% if vsphere_data and vsphere_data.datastore_clusters %}
                                        {% for datastore in vsphere_data.datastore_clusters %}
                                            <option value="{{ datastore.id }}">{{ datastore.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="datastore-loading-status">Waiting for cluster selection...</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="network">Network:</label>
                                <select id="network" name="network" required>
                                    <option value="">Select Network</option>
                                    {% if vsphere_data and vsphere_data.networks %}
                                        {% for network in vsphere_data.networks %}
                                            <option value="{{ network.id }}">{{ network.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="network-loading-status">Waiting for datacenter selection...</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="template">Template:</label>
                                <select id="template" name="template" required>
                                    <option value="">Select Template</option>
                                    {% if vsphere_data and vsphere_data.templates %}
                                        {% for template in vsphere_data.templates %}
                                            <option value="{{ template.id }}">{{ template.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="loading-status" id="template-loading-status">Waiting for datacenter selection...</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>VM Specifications</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quantity">Number of VMs:</label>
                                <input type="number" id="quantity" name="quantity" min="1" max="10" value="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="num_cpus">CPU Cores:</label>
                                <select id="num_cpus" name="num_cpus">
                                    <option value="1">1 Core</option>
                                    <option value="2" selected>2 Cores</option>
                                    <option value="4">4 Cores</option>
                                    <option value="8">8 Cores</option>
                                    <option value="16">16 Cores</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="memory">Memory (MB):</label>
                                <select id="memory" name="memory">
                                    <option value="2048">2 GB</option>
                                    <option value="4096" selected>4 GB</option>
                                    <option value="8192">8 GB</option>
                                    <option value="16384">16 GB</option>
                                    <option value="32768">32 GB</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Storage Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="disk_size">Primary Disk (GB):</label>
                                <select id="disk_size" name="disk_size">
                                    <option value="20">20 GB</option>
                                    <option value="50" selected>50 GB</option>
                                    <option value="100">100 GB</option>
                                    <option value="200">200 GB</option>
                                    <option value="500">500 GB</option>
                                </select>
                            </div>
                        </div>

                        <div id="additional_disks">
                            <h4>Additional Disks <button type="button" id="add_disk" class="btn-small">Add Disk</button></h4>
                            <div class="disk-list"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>User Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="build_owner">Your Name:</label>
                                <input type="text" id="build_owner" name="build_owner" value="{{ user_name }}" readonly>
                                <small>This name will be associated with the VM configuration</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Create VM Configuration</button>
                        <button type="reset" class="btn">Reset</button>
                    </div>
                </form>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 CH Robinson - RHEL9 VM Provisioning Tool</p>
        </footer>
    </div>

    <!-- Add the vsphere data as a hidden JSON object to be accessible to JavaScript -->
    {% if vsphere_data %}
    <script>
        window.initialVSphereData = {{ vsphere_data|tojson|safe }};
    </script>
    {% endif %}
    
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
